volumes:
  wp_uploads:
  wp_plugins:
  wp_themes:
  redis_data:

services:
  wp:
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - ./.env
    environment:
      # Mapped to wp-config.php via getenv()
      WORDPRESS_DB_HOST: ${WORDPRESS_DB_HOST}
      WORDPRESS_DB_USER: ${WORDPRESS_DB_USER}
      WORDPRESS_DB_PASSWORD: ${WORDPRESS_DB_PASSWORD}
      WORDPRESS_DB_NAME: ${WORDPRESS_DB_NAME}
      WP_ENV: ${WP_ENV:-production}
      WP_DEBUG: ${WP_DEBUG:-false}
      WP_HOME: https://${WP_DOMAIN}
      WP_SITEURL: https://${WP_DOMAIN}
      # WordPress Salts for security
      WORDPRESS_AUTH_KEY: ${WORDPRESS_AUTH_KEY}
      WORDPRESS_SECURE_AUTH_KEY: ${WORDPRESS_SECURE_AUTH_KEY}
      WORDPRESS_LOGGED_IN_KEY: ${WORDPRESS_LOGGED_IN_KEY}
      WORDPRESS_NONCE_KEY: ${WORDPRESS_NONCE_KEY}
      WORDPRESS_AUTH_SALT: ${WORDPRESS_AUTH_SALT}
      WORDPRESS_SECURE_AUTH_SALT: ${WORDPRESS_SECURE_AUTH_SALT}
      WORDPRESS_LOGGED_IN_SALT: ${WORDPRESS_LOGGED_IN_SALT}
      WORDPRESS_NONCE_SALT: ${WORDPRESS_NONCE_SALT}
      # WordPress Redis Cache plugin configuration
      WP_REDIS_HOST: redis
      WP_REDIS_PORT: 6379
      WP_REDIS_DATABASE: 0
    volumes:
      - wp_uploads:/var/www/html/wp-content/uploads
      - wp_plugins:/var/www/html/wp-content/plugins
      # Theme volume excludes headless-api to allow code updates
      - wp_themes:/var/www/html/wp-content/themes
      # Mount your custom theme from source code (overrides volume for this specific theme)
      - ./wp-content/themes/headless-api:/var/www/html/wp-content/themes/headless-api
    networks:
      - web
    labels:
      - "traefik.enable=true"
      
      # HTTP Router - Redirects to HTTPS
      ## "wp-cms" is the name of the router, can be anything unique change if you will have multiple wordpress containers may conflict
      ## Host(`${WP_DOMAIN}`) should match your domain name

      - "traefik.http.routers.wp-cms.rule=Host(`${WP_DOMAIN}`)"
      - "traefik.http.routers.wp-cms.entrypoints=web"
      - "traefik.http.routers.wp-cms.middlewares=redirect-to-https"

      # HTTPS Router
      - "traefik.http.routers.wp-cms-secure.rule=Host(`${WP_DOMAIN}`)"
      - "traefik.http.routers.wp-cms-secure.entrypoints=websecure"
      - "traefik.http.routers.wp-cms-secure.tls=true"
      - "traefik.http.routers.wp-cms-secure.tls.certresolver=le"

      # Service configuration
      - "traefik.http.services.wp-cms.loadbalancer.server.port=80"

      # Middleware for HTTP to HTTPS redirect
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"
    
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - redis
    
    # Health check for better monitoring
    #healthcheck:
    #  test: ["CMD", "curl", "-f", "http://localhost/wp-login.php"]
    #  interval: 30s
    #  timeout: 10s
    #  retries: 3
    #  start_period: 40s

  redis:
    image: redis:7-alpine
    ## Optional: Change wp-cms to your project name to avoid conflicts if running multiple stacksTrju
    container_name: wp-cms-redis
    volumes:
      - redis_data:/data
    networks:
      - web
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    # Optional: Redis configuration file
    # volumes:
    #   - ./config/redis.conf:/usr/local/etc/redis/redis.conf
    # command: redis-server /usr/local/etc/redis/redis.conf

networks:
  web:
    external: true
